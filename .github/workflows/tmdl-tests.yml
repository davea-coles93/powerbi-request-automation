name: TMDL Validation Tests

on:
  pull_request:
    branches: [master, main]
    paths:
      - 'scripts/validate-tmdl.js'
      - 'scripts/deploy-tmdl-model.js'
      - 'scripts/extract-measures.js'
      - 'aas-validator/**'
      - 'tests/tmdl-validation/**'
      - '.github/workflows/tmdl-tests.yml'
  push:
    branches: [master, main]
    paths:
      - 'scripts/validate-tmdl.js'
      - 'scripts/deploy-tmdl-model.js'
      - 'aas-validator/**'
      - 'tests/tmdl-validation/**'
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    name: Run TMDL Validation Test Suite

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Build AAS Validator
        working-directory: ./aas-validator/AasValidator
        run: dotnet build -c Release

      - name: Run syntax validation tests
        run: |
          echo "Running TMDL validation test suite (syntax validation only)"
          node tests/tmdl-validation/run-tests.js

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/tmdl-validation/test-results.json

      - name: Post test summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'tests/tmdl-validation/test-results.json';

            if (!fs.existsSync(resultsPath)) {
              console.log('No test results found');
              return;
            }

            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));

            const passEmoji = results.summary.failed === 0 ? '✅' : '❌';
            const successRate = ((results.summary.passed / results.summary.total) * 100).toFixed(1);

            let body = `## ${passEmoji} TMDL Validation Test Results\n\n`;
            body += `**Summary**\n`;
            body += `- Total tests: ${results.summary.total}\n`;
            body += `- Passed: ✅ ${results.summary.passed}\n`;
            body += `- Failed: ❌ ${results.summary.failed}\n`;
            body += `- Success rate: ${successRate}%\n\n`;

            body += `**Test Details**\n\n`;
            body += `| Test ID | Status | Name |\n`;
            body += `|---------|--------|------|\n`;

            for (const result of results.results) {
              const statusEmoji = result.status === 'PASSED' ? '✅' : '❌';
              const testInfo = require('./tests/tmdl-validation/test-suite.json')
                .tests.find(t => t.id === result.test);
              body += `| ${result.test} | ${statusEmoji} ${result.status} | ${testInfo?.name || 'Unknown'} |\n`;
            }

            body += `\n---\n`;
            body += `_Test run completed at ${results.timestamp}_`;

            if (context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              console.log(body);
            }

  # Optional: Run with AAS validation (requires secrets)
  run-tests-with-aas:
    runs-on: ubuntu-latest
    name: Run TMDL Tests with Azure AAS
    if: vars.ENABLE_AAS_VALIDATION == 'true'
    needs: run-tests

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    env:
      AZURE_AAS_SERVER: ${{ secrets.AZURE_AAS_SERVER }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build AAS Validator
        working-directory: ./aas-validator/AasValidator
        run: dotnet build -c Release

      - name: Get Azure access token for AAS
        id: get-token
        run: |
          TOKEN=$(az account get-access-token --resource "https://*.asazure.windows.net" --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "AAS_ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Deploy test model to AAS
        env:
          AAS_ACCESS_TOKEN: ${{ env.AAS_ACCESS_TOKEN }}
        run: |
          # Generate test database name
          TEST_DB="tmdl-test-$(date +%s)"
          echo "CI_DATABASE_NAME=$TEST_DB" >> $GITHUB_ENV
          export CI_DATABASE_NAME="$TEST_DB"

          # Deploy model
          node scripts/deploy-tmdl-model.js models/adventure-works/sales-sample.SemanticModel

          # Deploy using .NET validator
          TMSL_FILE="scripts/${TEST_DB}.tmsl.json"
          cd aas-validator/AasValidator
          dotnet run --no-build --configuration Release -- \
            --server "$AZURE_AAS_SERVER" \
            --token "$AAS_ACCESS_TOKEN" \
            --command executetmsl \
            --file "../../$TMSL_FILE"
          cd ../..

      - name: Run full validation tests with AAS
        env:
          AAS_ACCESS_TOKEN: ${{ env.AAS_ACCESS_TOKEN }}
        run: |
          echo "Running TMDL validation test suite with Azure AAS"
          node tests/tmdl-validation/run-tests.js

      - name: Cleanup test database
        if: always()
        env:
          AAS_ACCESS_TOKEN: ${{ env.AAS_ACCESS_TOKEN }}
        run: |
          if [ -n "$CI_DATABASE_NAME" ]; then
            cd aas-validator/AasValidator
            dotnet run --no-build --configuration Release -- \
              --server "$AZURE_AAS_SERVER" \
              --token "$AAS_ACCESS_TOKEN" \
              --command deletedb \
              --database "$CI_DATABASE_NAME" || true
            cd ../..
          fi

      - name: Upload full test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-with-aas
          path: tests/tmdl-validation/test-results.json

      - name: Azure Logout
        if: always()
        run: az logout || true
