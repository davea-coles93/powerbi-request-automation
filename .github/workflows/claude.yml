name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-response:
    # Only run if @claude is mentioned or issue is assigned to claude
    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.issue.body, '@claude') ||
      contains(github.event.pull_request.body, '@claude') ||
      github.event.issue.assignee.login == 'claude[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # PowerBI-specific instructions
          custom_instructions: |
            This is a PowerBI request automation system. When implementing changes:
            1. Analyze the request to determine change type (DAX formula, new measure, schema change, etc.)
            2. For DAX changes, ensure valid syntax and follow PowerBI best practices
            3. Run the triage logic to classify as auto_fix, assisted_fix, or human_design
            4. Test changes against the mock PowerBI service
            5. Create descriptive commit messages

            Key files:
            - backend/src/services/triageService.ts - Request classification
            - backend/src/services/executionService.ts - Change execution
            - backend/src/services/powerbiMockService.ts - PowerBI mock for testing
            - backend/src/types/request.ts - Request type definitions

  # Self-healing: Fix failed DAX validation
  self-heal:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'synchronize' &&
      !contains(github.event.pull_request.labels.*.name, 'auto-heal-failed')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for failed DAX validation
        id: check-failure
        uses: actions/github-script@v7
        with:
          script: |
            // Safety: Check current labels for retry count
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            const labels = pr.labels.map(l => l.name);
            const healAttempts = labels.filter(l => l.startsWith('heal-attempt-')).length;
            const MAX_HEAL_ATTEMPTS = 2;

            if (healAttempts >= MAX_HEAL_ATTEMPTS) {
              console.log(`Already attempted ${healAttempts} heal(s). Max ${MAX_HEAL_ATTEMPTS} reached. Stopping.`);
              core.setOutput('should_heal', 'false');

              // Add label indicating giving up
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['auto-heal-failed']
              });

              // Comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: 'âš ï¸ **Auto-heal limit reached**\n\nAttempted to fix this PR ' + healAttempts + ' times but tests still failing. Manual review needed.\n\nPlease check the test logs and fix the issue manually.'
              });

              return;
            }

            // Check for test failure
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });

            const daxCheck = checks.check_runs.find(c => c.name === 'DAX Validation (Azure Analysis Services)');

            if (daxCheck && daxCheck.conclusion === 'failure') {
              console.log('DAX validation failed - triggering self-heal');
              core.setOutput('should_heal', 'true');
              core.setOutput('check_url', daxCheck.html_url);
              core.setOutput('attempt_number', healAttempts + 1);

              // Add label to track this attempt
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [`heal-attempt-${healAttempts + 1}`]
              });
            } else {
              console.log('No DAX validation failure detected');
              core.setOutput('should_heal', 'false');
            }

      - name: Notify healing attempt
        if: steps.check-failure.outputs.should_heal == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: 'ðŸ”§ **Auto-heal attempt ${{ steps.check-failure.outputs.attempt_number }}/2**\n\nDAX validation failed. Claude is analyzing the error and attempting to fix...'
            });

      - name: Self-heal with Claude
        if: steps.check-failure.outputs.should_heal == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          custom_instructions: |
            A DAX validation test just failed on this PR (Attempt ${{ steps.check-failure.outputs.attempt_number }}/2).

            Your task is to fix the issue:

            1. Read the PR description to understand what measure was created
            2. Check the GitHub Actions test logs to see the actual error
            3. Identify the root cause (syntax error, wrong table, invalid DAX, etc.)
            4. Fix ONLY the TMDL file that was changed in this PR
            5. Commit with a clear message like "Fix: Correct [specific issue]"
            6. Push to this branch - tests will re-run automatically

            IMPORTANT CONSTRAINTS:
            - This is attempt ${{ steps.check-failure.outputs.attempt_number }} of 2 max attempts
            - Only modify the TMDL file that was already changed in this PR
            - Do NOT modify any other files (workflows, backend code, etc.)
            - Maintain proper TMDL syntax and lineageTag formatting
            - Keep the measure's business purpose as described in PR
            - If the error is infrastructure-related (server down, auth issues), comment explaining it but don't retry

  # Auto-triage new issues
  auto-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-label PowerBI requests
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body?.toLowerCase() || '';
            const title = issue.title?.toLowerCase() || '';

            const labels = [];

            // Classify by change type
            if (body.includes('dax') || body.includes('formula') || body.includes('measure')) {
              labels.push('dax-change');
            }
            if (body.includes('report') || body.includes('visual') || body.includes('dashboard')) {
              labels.push('report-change');
            }
            if (body.includes('schema') || body.includes('table') || body.includes('relationship')) {
              labels.push('schema-change');
            }

            // Classify by urgency
            if (title.includes('urgent') || title.includes('critical') || body.includes('asap')) {
              labels.push('priority-high');
            }

            // Auto-assign to claude for simple requests
            if (labels.includes('dax-change') && !labels.includes('schema-change')) {
              labels.push('auto-fix-candidate');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }
