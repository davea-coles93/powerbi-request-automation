name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-response:
    # Only run if @claude is mentioned or issue is assigned to claude
    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.issue.body, '@claude') ||
      contains(github.event.pull_request.body, '@claude') ||
      github.event.issue.assignee.login == 'claude[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # PowerBI-specific instructions
          custom_instructions: |
            This is a PowerBI request automation system. When implementing changes:
            1. Analyze the request to determine change type (DAX formula, new measure, schema change, etc.)
            2. For DAX changes, ensure valid syntax and follow PowerBI best practices
            3. Run the triage logic to classify as auto_fix, assisted_fix, or human_design
            4. Test changes against the mock PowerBI service
            5. Create descriptive commit messages

            Key files:
            - backend/src/services/triageService.ts - Request classification
            - backend/src/services/executionService.ts - Change execution
            - backend/src/services/powerbiMockService.ts - PowerBI mock for testing
            - backend/src/types/request.ts - Request type definitions

  # Auto-triage new issues
  auto-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-label PowerBI requests
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body?.toLowerCase() || '';
            const title = issue.title?.toLowerCase() || '';

            const labels = [];

            // Classify by change type
            if (body.includes('dax') || body.includes('formula') || body.includes('measure')) {
              labels.push('dax-change');
            }
            if (body.includes('report') || body.includes('visual') || body.includes('dashboard')) {
              labels.push('report-change');
            }
            if (body.includes('schema') || body.includes('table') || body.includes('relationship')) {
              labels.push('schema-change');
            }

            // Classify by urgency
            if (title.includes('urgent') || title.includes('critical') || body.includes('asap')) {
              labels.push('priority-high');
            }

            // Auto-assign to claude for simple requests
            if (labels.includes('dax-change') && !labels.includes('schema-change')) {
              labels.push('auto-fix-candidate');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }
